-- Main Controller Script with GUI Log

repeat wait() until game:IsLoaded()

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local playerName = LocalPlayer.Name
local workspaceFolder = "workspace"

-- GUI Log
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "LogGui"
ScreenGui.Parent = game.CoreGui

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 200, 0, 50)
Frame.Position = UDim2.new(0, 10, 0, 10)
Frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
Frame.Parent = ScreenGui

local LogLabel = Instance.new("TextLabel")
LogLabel.Size = UDim2.new(1, 0, 1, 0)
LogLabel.Position = UDim2.new(0, 0, 0, 0)
LogLabel.BackgroundTransparency = 1
LogLabel.Text = "(...)"
LogLabel.TextColor3 = Color3.fromRGB(255,255,255)
LogLabel.Font = Enum.Font.SourceSansBold
LogLabel.TextSize = 18
LogLabel.Parent = Frame

local function updateLog(msg)
    LogLabel.Text = "(...) " .. msg
    print(msg)
end

-- Scripts
local scriptA = 'getgenv().Team = "Marines"\nloadstring(game:HttpGet("https://api.luarmor.net/files/v3/loaders/85e904ae1ff30824c1aa007fc7324f8f.lua"))()'
local scriptB = [[
getgenv().Config = {
    ["Auto Get Cyborg"] = true,
    ["Auto Get Fully Cyborg"] = true
}
repeat wait() until game:IsLoaded() and game.Players.LocalPlayer 
getgenv().Key = "e9162fb60364a89d94d75009" 
loadstring(game:HttpGet("https://raw.githubusercontent.com/obiiyeuem/vthangsitink/main/BananaHub.lua"))()
]]
local scriptC = [[
getgenv().Config = {
    ["Auto Upgrade Race V2-V3"] = true
}
repeat wait() until game:IsLoaded() and game.Players.LocalPlayer 
getgenv().Key = "e9162fb60364a89d94d75009" 
loadstring(game:HttpGet("https://raw.githubusercontent.com/obiiyeuem/vthangsitink/main/BananaHub.lua"))()
]]
local scriptD = [[
getgenv().Config = {
    ["Get Fruit In Inventory Low Beli"] = true,
    ["Auto Raid"] = true 
}
repeat wait() until game:IsLoaded() and game.Players.LocalPlayer 
getgenv().Key = "e9162fb60364a89d94d75009" 
loadstring(game:HttpGet("https://raw.githubusercontent.com/obiiyeuem/vthangsitink/main/BananaHub.lua"))()
]]

-- Kiểm tra Fist of Darkness
local function hasFistOfDarkness()
    for _, item in pairs(LocalPlayer.Backpack:GetChildren()) do
        if item.Name:lower():find("fist of darkness") then
            return true
        end
    end
    return false
end

-- Kiểm tra fragment
local function getFragment()
    local stats = LocalPlayer:FindFirstChild("Data") or LocalPlayer
    return stats:FindFirstChild("Fragments") and stats.Fragments.Value or 0
end

-- Kiểm tra Cyborg
local function hasCyborg()
    local stats = LocalPlayer:FindFirstChild("Data") or LocalPlayer
    return stats:FindFirstChild("Race") and stats.Race.Value == "Cyborg"
end

-- Kiểm tra Cyborg V3
local function hasCyborgV3()
    local stats = LocalPlayer:FindFirstChild("Data") or LocalPlayer
    return stats:FindFirstChild("Race") and stats.Race.Value == "Cyborg" and stats:FindFirstChild("RaceLevel") and stats.RaceLevel.Value == 3
end

-- Lưu trạng thái fist vào workspace (dùng mẫu tham khảo)
local function saveFistStatus()
    local jsonData = string.format('{"name":"%s","timestamp":"%s","fist":true}', playerName, os.date("!%Y-%m-%dT%H:%M:%SZ"))
    writefile(workspaceFolder.."/"..playerName..".json", jsonData)
    updateLog("Đã lưu trạng thái fist cho " .. playerName)
end

-- Kiểm tra trạng thái fist đã lưu
local function isFistSaved()
    local file = workspaceFolder.."/"..playerName..".json"
    if isfile(file) then
        local data = HttpService:JSONDecode(readfile(file))
        return data.fist == true
    end
    return false
end

-- Hop server (placeholder)
local function hopServer()
    updateLog("Đang hop server...")
    -- loadstring(game:HttpGet("link_hop_server"))()
end

-- Chuyển về Sea 2
local function checkAndTravelToSea2()
    local seaIds = {[2753915549] = 1, [4442272183] = 2, [7449423635] = 3}
    local seaTravelCommands = {
        [1] = "TravelMain",
        [2] = "TravelDressrosa",
        [3] = "TravelZou"
    }
    local currentSea = seaIds[game.PlaceId]
    if currentSea ~= 2 then
        updateLog("Đang chuyển về Sea 2...")
        local command = seaTravelCommands[2]
        if command then
            pcall(ReplicatedStorage.Remotes.CommF_.InvokeServer, ReplicatedStorage.Remotes.CommF_, command)
            wait(5)
        end
    end
end

-- Main loop
spawn(function()
    while true do
        checkAndTravelToSea2()
        wait(2)
    end
end)

spawn(function()
    while true do
        if hasCyborgV3() then
            updateLog("done Cyborg V3")
            break
        end

        -- Fix: Nếu đã có fist thì lưu trạng thái và chạy script B ngay
        if not isFistSaved() then
            if hasFistOfDarkness() then
                saveFistStatus()
                updateLog("GET cyborg")
                loadstring(scriptB)()
            else
                updateLog("GET Fist of Darkness")
                loadstring(scriptA)()
            end
        else
            updateLog("gET CYBORG")
            loadstring(scriptB)()
        end

        if getFragment() < 1000 then
            hopServer()
            updateLog("Fragment dưới 1000, chạy script D")
            loadstring(scriptD)()
        end

        if hasCyborg() and not hasCyborgV3() then
            hopServer()
            updateLog("get V3")
            loadstring(scriptC)()
        end

        wait(1)
    end
end)
